datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  password           String
  name               String?
  passwordResetToken String?
  tokenExpiry        DateTime?
  role               String    @default("student") // "student" or "instructor"

  // Projects created by this instructor
  projects Project[] @relation("InstructorProjects")

  // Invites received by this student
  invites  Invite[]  @relation("StudentInvites")

  // ðŸ‘‡ add back relation to TeamMember
  teamMemberships TeamMember[]

  // Surveys created by this instructor
  createdSurveys Survey[] @relation("SurveyCreator")

  // Survey responses submitted by this user
  submittedResponses SurveyResponse[] @relation("Respondent")

  // Survey responses received about this user (as the target)
  receivedResponses  SurveyResponse[] @relation("TargetStudent")
}

model Project {
  id          String    @id @default(cuid())
  title       String
  description String

  instructor   User      @relation("InstructorProjects", fields: [instructorId], references: [id])
  instructorId String

  invites      Invite[]  @relation("ProjectInvites")

  // ðŸ‘‡ add back relation to Team
  teams        Team[]

  // Surveys assigned to this project
  surveyAssignments SurveyAssignment[]

  createdAt    DateTime  @default(now())
}

model Invite {
  id         String   @id @default(cuid())

  project    Project  @relation("ProjectInvites", fields: [projectId], references: [id], onDelete: Cascade)
  projectId  String

  student    User     @relation("StudentInvites", fields: [studentId], references: [id], onDelete: Cascade)
  studentId  String

  status     String   @default("pending") // pending | accepted | rejected
  createdAt  DateTime @default(now())
}

model Team {
  id         String    @id @default(cuid())
  name       String
  project    Project   @relation(fields: [projectId], references: [id])
  projectId  String
  members    TeamMember[]
  createdAt  DateTime  @default(now())
}

model TeamMember {
  id        String   @id @default(cuid())
  team      Team     @relation(fields: [teamId], references: [id])
  teamId    String
  student   User     @relation(fields: [studentId], references: [id])
  studentId String
}

model Survey {
  id          String   @id @default(cuid())
  title       String
  description String?

  // creator (instructor)
  creator   User   @relation("SurveyCreator", fields: [creatorId], references: [id])
  creatorId String

  assignments SurveyAssignment[]
  criteria    SurveyCriterion[]

  createdAt  DateTime @default(now())
}

model SurveyAssignment {
  id        String   @id @default(cuid())

  project   Project  @relation(fields: [projectId], references: [id])
  projectId String

  survey    Survey   @relation(fields: [surveyId], references: [id])
  surveyId  String

  deadline  DateTime
  status    String   @default("open") // open | closed

  createdAt DateTime @default(now())

  // Responses linked to this assignment
  responses SurveyResponse[]
}

model SurveyCriterion {
  id        String  @id @default(cuid())

  survey    Survey  @relation(fields: [surveyId], references: [id])
  surveyId  String

  label     String
  minRating Int     @default(1)
  maxRating Int     @default(5)
  order     Int
}

model SurveyResponse {
  id               String   @id @default(cuid())

  assignment       SurveyAssignment @relation(fields: [assignmentId], references: [id])
  assignmentId     String

  respondent       User    @relation("Respondent", fields: [respondentId], references: [id])
  respondentId     String

  // the student being evaluated (peer or self)
  targetStudent    User    @relation("TargetStudent", fields: [targetStudentId], references: [id])
  targetStudentId  String

  // JSON map of criterionId -> text answer
  answers          Json

  submittedAt      DateTime @default(now())

  @@unique([assignmentId, respondentId, targetStudentId])
}
